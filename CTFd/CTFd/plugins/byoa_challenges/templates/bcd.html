{% extends "core/base.html" %}
{% set debug = false %}

{% block content %}
    {%  if banner %}
        <div class="alert alert-{{ banner.level }} text-center" role="alert">
            <strong>{{ banner.msg }}</strong>
        </div>
    {%  endif %}
    <div class="container">
        <h2>BYOA Challenge Deployment</h2>
        {% if error %}
            {{ error }}
        {% endif %}
        {% if validation_result %}
            <h4>Validation Result</h4>
            <p>Result: {{ 'You have done it!' if validation_result.result else 'You have not fixed the issue yet :(' }}</p>
            <p>Message: {{ validation_result.message }}</p>
            {% if validation_result.result %}
                <p>Here is your flag: {{ validation_result.flag }}</p>
            {% endif %}
        {% endif %}
        {% if bcd %}
            <h3>{{ challenge.name }}</h3>
            <div class="row">{{ challenge.description|safe }}</div>
            <div class="row">
                <p>Deploy status: {{ bcd.deploy_status }}</p>
                {% if bcd.deploy_status == 'DEPLOYING' or bcd.deploy_status == 'DESTROYING' %}
                    <a href="/plugins/byoa_challenges/view/{{ challenge.id }}?check_job=true" style="margin-left:5px">Refresh Status</a>
                {% endif %}
            </div>
            <div class="row" style="margin-bottom: 10px; margin-top: 10px;" id="deploy-btns">
                {% if bcd.deploy_status == 'NOT_DEPLOYED'%}
                <div class="col-md-3">
                    <a href="/plugins/byoa_challenges/deploy/{{ challenge.id }}">
                        <button class="btn btn-outline-primary btn-outlined" id="challenge-deploy-btn">Deploy</button>
                    </a>
                </div>
                {% endif %}
                {% if bcd.deploy_status == 'DEPLOYED'%}
                <div class="col-md-3">
                    <a href="/plugins/byoa_challenges/validate/{{ challenge.id }}">
                        <button class="btn btn-outline-success btn-outlined" id="challenge-validate-btn" >Validate</button>
                    </a>
                </div>
                {% endif %}
                {% if bcd.deploy_status == 'DEPLOYED' or bcd.deploy_status == 'FAILED_DEPLOY'or bcd.deploy_status == 'FAILED_DESTROY'  %}
                <div class="col-md-3">
                    <a href="/plugins/byoa_challenges/destroy/{{ challenge.id }}">
                        <button class="btn btn-outline-danger btn-outlined" id="challenge-destroy-btn" >Destroy</button>
                    </a>
                </div>
                {%  endif %}
            </div>
            {% if bcd.deploy_status == 'DESTROYED' %}
                <p>Need to deploy again? Ask an admin to reset the status for you.</p>
            {% endif %}
            {% if k8s_deploy_job %}
                <h3>Latest Job Details</h3>
                <div class="row">
                    <p>
                        Create Time: {{ k8s_deploy_job._metadata.creation_timestamp }}<br>
                        Start Time: {{ k8s_deploy_job._status.start_time }}<br>
                        Completion Time: {{ k8s_deploy_job._status.completion_time }}<br>
                        Active: {{ k8s_deploy_job._status.active }}<br>
                        Failed: {{ k8s_deploy_job._status.failed }}<br>
                        Succeeded: {{ k8s_deploy_job._status.succeeded }}<br>
                        {% if k8s_deploy_job._metadata and k8s_deploy_job._metadata.labels and k8s_deploy_job._metadata.labels["job-name"] %}
                            Job Name: {{ k8s_deploy_job._metadata.labels["job-name"] }}
                        {% endif %}
                    </p>
                    {% if debug %}
                        DEBUG: K8s Job: {{ k8s_deploy_job|pprint}}
                        DEBUG: bcd: {{ bcd|pprint}}
                        DEBUG: challenge: {{ challenge|pprint}}
                    {%  endif %}
                </div>
            {% endif %}
        {% endif %}
        {% block challenge_content %}
            {% if bcd.ctf_metadata %}
                {% if bcd.ctf_metadata.status_summary %}
                    <p><strong>Current status summary: {{  bcd.ctf_metadata.status_summary }}</strong></p>
                {%  endif %}
            {%  endif %}
            <!-- Put custom code for each challenge here -->
        {% endblock %}
    {% if bcd.byoa_metadata %}
        {% if bcd.byoa_metadata.is_admin %}
            <h4>Admin Area</h4>
            <p>Local challenge ID: {{ challenge.id }}<br>
                Admin challenge Reference: {{ challenge.api_base_uri }}
            </p>
            <div class="col-md-3">
                <a href="/plugins/byoa_challenges/reset/{{ challenge.id }}"><button class="btn btn-outline-secondary btn-outlined" id="challenge-reset-btn"
                >Reset Status</button></a>
            </div>
            <div>
            {% if bcd.byoa_metadata.admin_job_url_deploy %}
                <a href="{{ bcd.byoa_metadata.admin_job_url_deploy  }}" target="_blank">View Deploy K8S Job</a>
            {% endif %}
            {% if bcd.byoa_metadata.admin_job_url_destroy %}
                <br><a href="{{ bcd.byoa_metadata.admin_job_url_destroy  }}" target="_blank">View Destroy K8S Job</a>
            {% endif %}
            </div>
        {% endif %}
    {% endif %}

    </div>
{% endblock %}